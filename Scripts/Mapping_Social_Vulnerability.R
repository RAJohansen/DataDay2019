#######################
###  Data Day 2019  ###
###  Power Session  ###
#######################

# Title: Interactive mapping of social vulnerability caused by climate change using R
# Authors: Richard Johansen & Mark Chalmers
# University of Cincinnati Libraries
# 4/1/2019

# Social Vulnerability Data: http://artsandsciences.sc.edu/geog/hvri
# Code: https://github.com/RAJohansen/DataDay2019

######################### PART 0 :Introduction to R ############################ 

# R as a Calculator
1 + 3

# Creating objects in R
# Hint alt - is a shortcut for the < - 
x <- 1+2
x
y <- x +1
y

# Getting Help in R
help(mean)
#HINT: if you can't remember exactly what function you are looking for, Use Tab
me "Tab"

#Not sure what its called 
#Try a fuzzy search
apropos("mea") 

# Viewing & Examinging a Data set
# Lets explore data using a data set thats contained in R
mtcars  <- mtcars

# View our table
# Or click the df object under the data window
View(mtcars)

# Use the names() function to return a list the variables 
names(mtcars)

#Look at the data types or structure of the data
str(mtcars)
# This is very useful when we analyzing or visualizing data
# Make sure your variables are in the appropiate format!!

## Quick and simple statistical summary of the data
summary(mtcars)

# Finding values from out data table
# Lets look at column 2 
mtcars[,2]

# Lets look at row 5
mtcars[5,]

# What value is in row 5 column 3?
mtcars[5,3]

# What if we want to know the max mpg
max(mtcars$mpg)

##################### PART  I: Plotting using Base R ############################ 

### Default Plot
plot(mtcars$mpg)

## Dotchart ##
dotchart(mtcars$mpg, labels=row.names(mtcars))

## Histogram ##
hist(mtcars$mpg)

# Colored Histogram with Different Number of Bins
hist(mtcars$mpg, breaks=10)

## Scatterplot ##
plot(mtcars$wt,mtcars$mpg)

## Box Plots ##
boxplot(mtcars$mpg~mtcars$cyl)

# Boxplot with labels
boxplot(mpg~cyl,
        data=mtcars,
        main="Car Milage Data", 
        xlab="Number of Cylinders",
        ylab="Miles Per Gallon")

########################### PART II:Data Acquisition############################ 

### Step 1: Install & load required packages 
#install.packages(c("tigris","tmap","tidyverse","tablulizer","dplyr","sf"))
library(tigris)
library(tmap)
library(tidyverse)
library(tabulizer)
library(dplyr)
library(sf)

### Step 2: Extract a web PDF
# Explore file location to ensure accuracy:
website <- "http://artsandsciences.sc.edu/geog/hvri/sites/sc.edu.geog.hvri/files/attachments/SoVI_10_14_Website.pdf"
browseURL(url = website)

# Use URL location to extract pdf as a table
# When you're unfamilar with a function you can use the ?
?extract_tables
Sovi_table <- extract_tables(website)

# Lets view what exactly is extracted through this process
View(Sovi_table)

#What a mess???

### Step 3: Converting the web-based PDF into csv

# Lets use two more functions to convert the extracted table
# into a more usable and analysis friendly format
# do.call?
# rbind?
final <- do.call(rbind, Sovi_table[-length(Sovi_table)])

# Reformate table headers by dropping the first row
final <- as.data.frame(final[2:nrow(final), ])

# Lets lable the column names so they can merged with Census data
headers <- c('GEOID', 'State_FIP', 'County_FIP', 'County_Name', 'CNTY_SoVI', 
             'Percentile')

# Apply our names to the data frame
names(final) <- headers


# **NOTE** GEOID is the ID code for CENSUS data
# This is mandatory for the next section

### Step 4: Save the table as a csv 
# This is helpful for eliminating redundancy and reproducibility
write.csv(final, file='Data/SoVI.csv', row.names=FALSE)


########################### PART III: Mapping in R ############################# 

# We can start directly from the objects in our working environment
#Or we can load the data saved in Part 1: Step 4

### Step 1: Load spatial objects into R from US Census Tigris files
# In this case we want to load counties
# The tigris package is connected to the Census's database so we can pull data directly
# We want to pull the spatial objects counties and save them as an R object 

# NOTE: this might take a couple minutes due to the size of the file
# Question: How many counties are there in the USA?

# Load USA Counties from tigris package (US CENSUS)
Counties <- counties()

# Convert Large SpatialPolygonsDataFrame to Simple Feature (sf)
Counties_sf <- st_as_sf(Counties)

#Subset data to only lower 48
Counties_Cont48 <- subset(Counties_sf,STATEFP != "69" & STATEFP != "02" & STATEFP != "60" & STATEFP != '66' & STATEFP != "15" & STATEFP != "72" & STATEFP != "78")

# Save Counties_Cont48 as CSV & GeoPackage
st_write(Counties_Cont48, dsn = 'Data/Counties_Cont48.gpkg')

#Select only Florida Counties & Save them
Counties_FL <- subset(Counties_sf,STATEFP == "12")
st_write(Counties_FL, dsn = 'Data/Counties_FL.gpkg')

#Read geopackage
Counties_FL <- st_read('Data/Counties_FL.gpkg')

View(Counties_FL)
# geom column

### Step 2: Merge SoVI csv with our county region spatial object
# Load data from package location if not currently loaded
df <- read.csv('Data/SoVI.csv')

# Create subset of SoVI data for just Florida Counties
df_FL <- subset(df,State_FIP == "12")
#Notice the number of rows is exactly the same as Counties_FL

# Now that we have both of objects loaded we can merged them using a common field
# This is a very common practice is GIS
# Each object must have the exact same set of unique identifiers for each row
# Using the merge fucntion we can combine the spatial object with our data frame
FL_SoVI <- merge(Counties_FL,df_FL, by = "GEOID", all = FALSE)

### Step 3: Lets make a simple plot to see the data
# We want to plot the spatial object from the values of the first column
# In this case that is the unique ID for each column
plot(FL_SoVI[1])

### Step 4: Mapping with tmap
# tmap uses the same grammar of graphics as ggplot
# We build on our graphics like layers on a cake

# Plot  data 
tm_shape(FL_SoVI) +
  tm_fill()

# Now add our county borders         
tm_shape(FL_SoVI) +
  tm_borders() + 
  tm_fill()

# Lets add our SoVI data to explore trends         
tm_shape(FL_SoVI) +
  tm_borders() + 
  tm_fill(col = "CNTY_SoVI")

# Manually define lable breaks
breaks = c(-6,-3,0,3,6)
tm_shape(FL_SoVI) +
  tm_borders() + 
  tm_fill(col = "CNTY_SoVI", breaks = breaks)


# We can explore color palettes
tmaptools::palette_explorer()

# Lets choose our own color palette and add a continuous scale bar
tm_shape(FL_SoVI) +
  tm_borders() + 
  tm_fill(col = "CNTY_SoVI", style = "cont", palette = "viridis")

# Add some cartographic elements
tm_shape(FL_SoVI) +
  tm_borders() + 
  tm_fill(col = "CNTY_SoVI", style = "cont", palette = "viridis") +
  tm_layout(title = "Florida SoVI Vulnerability Index by County",
            legend.outside = FALSE,
            frame = TRUE,
            inner.margins = 0.1,
            legend.title.size = 1.5,
            legend.text.size = 1.1) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 2) +
  tm_scale_bar(breaks = c(0, 100, 200),size = 0.8)
  

### Finally Lets save our plot

#Saving a plot
jpeg('C:/temp/My_Awesome_Map.jpg', width = 7, height = 7, units = "in", res =300)

tm_shape(FL_SoVI) +
  tm_borders() + 
  tm_fill(col = "CNTY_SoVI", style = "cont", palette = "viridis") +
  tm_layout(title = "Florida SoVI Vulnerability Index by County",
            legend.outside = FALSE,
            frame = TRUE,
            inner.margins = 0.1,
            legend.title.size = 1.5,
            legend.text.size = 1.1) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 2) +
  tm_scale_bar(breaks = c(0, 100, 200),size = 0.8)

dev.off()


### Step 4: Interactive Mapping with leaflet
map <- tm_shape(FL_SoVI) +
  tm_borders(alpha = 0.9) +
  tm_fill(col = "CNTY_SoVI",
          id = "NAME",
          popup.vars = c("NAME","CNTY_SoVI"))


tmap_leaflet(map)